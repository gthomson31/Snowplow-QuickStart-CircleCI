# Use the latest 2.1 version of CircleCI pipeline process engine.
# See: https://circleci.com/docs/2.0/configuration-reference
version: 2.1


parameters:
  workflow-id:
    type: string
    default: "${CIRCLE_WORKFLOW_ID:0:7}"

# Define a job to be invoked later in a workflow.
# See: https://circleci.com/docs/2.0/configuration-reference/#jobs
jobs:
  git-repo:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run:
          name: Clone Repo
          command: git clone https://github.com/snowplow/quickstart-examples.git ~/quickstart-examples
      - run:
          name: Check Repo
          command: cd ~/quickstart-examples && ls -la
  iglu-server-prep:
    docker:
      - image: cimg/base:stable
    steps:
      - checkout
      - attach_workspace:
          at: ~/
      - run:
          name: Clone Repo
          command: git clone https://github.com/snowplow/quickstart-examples.git ~/quickstart-examples

      - run: 
          name: Patching Iglue Vars File
          command: ./scripts/patch_iglu_vars.sh          
      - run:
          name: Check Repo
          command: cat ~/quickstart-examples/terraform/aws/iglu_server/default/terraform.tfvars
      - save_cache:
          paths: 
            - ~/quickstart-examples/terraform/aws/iglu_server/default
          key: quickstart-build-${CIRCLE_WORKFLOW_ID}


  # iglu-server-build:
  #   docker:
  #     - image: cimg/base:stable
  #   steps:
  #     - checkout
  #     - attach_workspace:
  #         at: ~/
  #     - run:
  #         name: Clone Repo
  #         command: git clone https://github.com/snowplow/quickstart-examples.git ~/quickstart-examples
  #     - run: 
  #         name: Change into the Repo and Update Vars
  #         cd ~/quickstart-examples/terraform/aws

  #     - run: |
  #         sed -i '' 's/prefix = .*/prefix = $PREFIX/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/vpc_id            = .*/vpc_id = "$VPC_ID"/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/public_subnet_ids = .*/public_subnet_ids = ["$PUBLIC_SUBNET_1","$PUBLIC_SUBNET_2"]/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/ssh_ip_allowlist = .*/ssh_ip_allowlist = ["$ALLOWED_IP"]/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/ssh_public_key = .*/ssh_public_key = ["$SSH_PUBLIC_KEY"]/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/iglu_db_password = .*/iglu_db_password = "$IGLU_DB_PASSWORD"/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/iglu_super_api_key = .*/iglu_super_api_key = "$IGLU_API_KEY"/g' iglu_server/default/terraform.tfvars
  #         sed -i '' 's/iam_permissions_boundary = .*/iam_permissions_boundary = "$IAM_PERMISSIONS_BOUNDRY"/g' iglu_server/default/terraform.tfvars          
  #     - run:
  #         name: Check Repo
  #         command: cat ~/quickstart-examples/terraform/aws/iglu_server/default/terraform.tfvars
  #     - save_cache:
  #         paths: 
  #           - ~/quickstart-examples/terraform/aws/iglu_server/default
  #         key: quickstart-build-${CIRCLE_WORKFLOW_ID}


# Invoke jobs via workflows
# See: https://circleci.com/docs/2.0/configuration-reference/#workflows
workflows:
  quickstart-workflow:
    jobs:
      - git-repo
      - iglu-server-prep:
          requires:
            - git-repo
      # - iglu-server-build:
      #     requires:
      #       - iglu-server-prep

